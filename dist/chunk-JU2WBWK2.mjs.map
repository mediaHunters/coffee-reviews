{"version":3,"sources":["../src/ui/common/config/application/express/auth/middlewares/isAuthenticated.ts"],"sourcesContent":["import * as express from 'express';\n\nimport { FORBIDDEN, getStatusText, UNAUTHORIZED } from 'http-status-codes';\n\nimport { getCurrentUser } from 'ui/common/config/application/express/auth/utils/getHttpContext';\nimport { UserInterfaceError } from 'ui/common/config/errors/UserInterfaceError';\n\nexport const isAuthenticated =\n  (config?: { role: string }) =>\n  async (\n    req: express.Request,\n    _res: express.Response,\n    next: express.NextFunction\n  ): Promise<void> => {\n    const user = getCurrentUser(req);\n    // eslint-disable-next-line no-console\n    if (!user) {\n      next(\n        new UserInterfaceError(\n          UNAUTHORIZED,\n          getStatusText(UNAUTHORIZED).toUpperCase()\n        )\n      );\n      return;\n    }\n\n    const isAuthenticatedUser = await user.isAuthenticated();\n\n    if (!isAuthenticatedUser) {\n      next(\n        new UserInterfaceError(\n          UNAUTHORIZED,\n          getStatusText(UNAUTHORIZED).toUpperCase()\n        )\n      );\n      return;\n    }\n\n    if (config) {\n      const isInRole = await user.isInRole(config.role);\n      if (!isInRole) {\n        next(\n          new UserInterfaceError(\n            FORBIDDEN,\n            getStatusText(FORBIDDEN).toUpperCase()\n          )\n        );\n        return;\n      }\n    }\n    next();\n  };\n"],"mappings":";;;;;;;;AAEA,SAAS,WAAW,eAAe,oBAAoB;AAKhD,IAAM,kBACX,CAAC,WACD,OACE,KACA,MACA,SACkB;AAClB,QAAM,OAAO,eAAe,GAAG;AAE/B,MAAI,CAAC,MAAM;AACT;AAAA,MACE,IAAI;AAAA,QACF;AAAA,QACA,cAAc,YAAY,EAAE,YAAY;AAAA,MAC1C;AAAA,IACF;AACA;AAAA,EACF;AAEA,QAAM,sBAAsB,MAAM,KAAK,gBAAgB;AAEvD,MAAI,CAAC,qBAAqB;AACxB;AAAA,MACE,IAAI;AAAA,QACF;AAAA,QACA,cAAc,YAAY,EAAE,YAAY;AAAA,MAC1C;AAAA,IACF;AACA;AAAA,EACF;AAEA,MAAI,QAAQ;AACV,UAAM,WAAW,MAAM,KAAK,SAAS,OAAO,IAAI;AAChD,QAAI,CAAC,UAAU;AACb;AAAA,QACE,IAAI;AAAA,UACF;AAAA,UACA,cAAc,SAAS,EAAE,YAAY;AAAA,QACvC;AAAA,MACF;AACA;AAAA,IACF;AAAA,EACF;AACA,OAAK;AACP;","names":[]}